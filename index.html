<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>특별조건 차량 재고 검색</title>
<style>
  :root {
    --gap:.75rem; --border:#d0d7de; --accent:#0d6efd; --accent-bg:#e7f1ff; --danger:#c00000;
    --radius:12px; --bg:#ffffff; --gray:#555; --shadow:0 2px 4px rgba(0,0,0,.08)
  }
  * { box-sizing:border-box; }
  body { margin:0; font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans KR",Helvetica,Arial,sans-serif; background:#f6f8fa; color:#222; }
  header { padding:1.25rem 1rem .75rem; background:#fff; box-shadow:var(--shadow); position:sticky; top:0; z-index:10; }
  h1 { margin:0 0 .5rem; font-size:1.25rem; }
  form.filters { display:grid; gap:var(--gap); grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); align-items:end; }
  form.filters label { display:flex; flex-direction:column; font-size:.75rem; font-weight:600; gap:.35rem; letter-spacing:.5px; text-transform:uppercase; color:#333; }
  select, input[type=number], input[type=text] {
    appearance:none; border:1px solid var(--border); padding:.55rem .6rem; border-radius:var(--radius);
    background:#fff; font-size:.85rem; box-shadow:0 1px 0 rgba(0,0,0,.02) inset;
  }
  select[multiple] { height:120px; }
  button { cursor:pointer; border:1px solid var(--accent); background:var(--accent); color:#fff; padding:.6rem 1rem;
    border-radius:var(--radius); font-weight:600; font-size:.85rem; letter-spacing:.5px;
  }
  button.secondary { background:#fff; color:var(--accent); }
  button:disabled { opacity:.4; cursor:not-allowed; }
  #count { margin:1rem 0 .5rem; font-weight:700; color:var(--danger); }
  main { padding:1rem; }
  table { width:100%; border-collapse:collapse; font-size:.78rem; background:#fff; }
  thead th { position:sticky; top:0; background:#fff; box-shadow:0 1px 0 var(--border); z-index:5; }
  th, td { padding:.5rem .55rem; border:1px solid #e5e7eb; text-align:left; vertical-align:top; }
  tbody tr:nth-child(even) { background:#fafafa; }
  .pillbox { display:flex; flex-wrap:wrap; gap:.4rem; margin:.4rem 0 0; }
  .pill { background:var(--accent-bg); color:#014a9c; padding:.25rem .55rem; border-radius:999px; font-size:.65rem; display:inline-flex; align-items:center; gap:.35rem; }
  .pill button { all:unset; cursor:pointer; font-weight:700; }
  .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; margin-top:.3rem; }
  .summary { font-size:.7rem; color:var(--gray); }
  #loading { padding:2rem; text-align:center; font-size:.9rem; }
  .no-results { padding:1rem; text-align:center; font-size:.85rem; background:#fff; border:1px dashed var(--border); border-radius:var(--radius); }
  footer { margin:2rem 0 3rem; text-align:center; font-size:.65rem; color:var(--gray); }
</style>
</head>
<body>
  <header>
    <h1>특별조건 차량 재고 검색</h1>
    <form id="filterForm" class="filters" autocomplete="off">
      <label>차종
        <select name="차종" id="차종">
          <option value="">전체</option>
        </select>
      </label>
      <label>트림 / 상세사양
        <select name="트림" id="트림">
          <option value="">전체</option>
        </select>
      </label>
      <label>옵션
        <select name="옵션" id="옵션">
          <option value="">전체</option>
        </select>
      </label>
      <label>외장색 (다중선택)
        <select name="외장색" id="외장색" multiple></select>
        <div id="extColorPills" class="pillbox"></div>
      </label>
      <label>내장색
        <select name="내장색" id="내장색">
          <option value="">전체</option>
        </select>
      </label>
      <label>출고센터
        <select name="출고센터" id="출고센터">
          <option value="">전체</option>
        </select>
      </label>
      <label>최대 판매가
        <input type="number" id="maxPrice" placeholder=\"숫자만\" inputmode=\"numeric\" />
      </label>
      <div class=\"toolbar\">
        <button type=\"submit\">검색</button>
        <button type=\"button\" class=\"secondary\" id=\"resetBtn\">초기화</button>
      </div>
      <div class=\"summary\" id=\"summary\"></div>
    </form>
    <div id=\"count\">데이터 로딩 중...</div>
  </header>
  <main>
    <div id=\"loading\">재고 데이터를 불러오는 중...</div>
    <div style=\"overflow:auto; max-height:70vh; border:1px solid var(--border); border-radius:var(--radius);\">
      <table id=\"resultTable\" style=\"display:none;\">
        <thead>
          <tr>
            <th>#</th>
            <th>차종</th>
            <th>차량상태</th>
            <th>트림 / 상세사양</th>
            <th>옵션</th>
            <th>외장색</th>
            <th>내장색</th>
            <th>생산번호</th>
            <th>출고센터</th>
            <th>생산일</th>
            <th>판매코드(통합)</th>
            <th>판매가</th>
            <th>조건 계</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div id=\"noResults\" class=\"no-results\" style=\"display:none;\">조건에 맞는 재고가 없습니다.</div>
  </main>
  <footer>
    © <span id=\"year\"></span> 재고 검색. (GitHub Pages용)
  </footer>

<script>
const DATA_URL = 'inventory.json';
let rawData = [];
let filtered = [];

const $ = sel => document.querySelector(sel);
const form = $('#filterForm');
const countEl = $('#count');
const table = $('#resultTable');
const tbody = table.querySelector('tbody');
const extSelect = $('#외장색');
const extPills = $('#extColorPills');
const summaryEl = $('#summary');
const noResults = $('#noResults');
const loadingEl = $('#loading');
const yearEl = $('#year');
yearEl.textContent = new Date().getFullYear();

async function loadData() {
  try {
    const res = await fetch(DATA_URL);
    if(!res.ok) throw new Error('데이터 로드 실패');
    rawData = await res.json();
    normalizeKeys(rawData);
    buildFilterOptions(rawData);
    applyFilter(); // initial
  } catch(e) {
    loadingEl.textContent = '데이터를 불러오지 못했습니다: ' + e.message;
  } finally {
    loadingEl.style.display = 'none';
  }
}

function normalizeKeys(data) {
  data.forEach(r => {
    // 트림 없고 상세사양 있으면 맵핑
    if(!r['트림'] && r['상세사양']) r['트림'] = r['상세사양'];
    // 조건_계 변형
    if(!r['조건_계'] && r['조건 계']) r['조건_계'] = r['조건 계'];
    if(!r['조건 계'] && r['조건_계']) r['조건 계'] = r['조건_계'];
    // 판매가 숫자화
    if(r['판매가'] && typeof r['판매가'] === 'string') {
      const num = r['판매가'].replace(/[^0-9.-]/g,'');
      r['판매가'] = num ? Number(num) : r['판매가'];
    }
  });
}

function getUniqueValues(key) {
  const set = new Set(rawData.map(r => r[key]).filter(v => v !== undefined && v !== null && v !== ''));
  return [...set].sort((a,b)=> (''+a).localeCompare(''+b,'ko'));
}

function buildFilterOptions(data) {
  const map = {
    '차종':'#차종',
    '트림':'#트림',
    '옵션':'#옵션',
    '외장색':'#외장색',
    '내장색':'#내장색',
    '출고센터':'#출고센터'
  };
  Object.entries(map).forEach(([key, selector]) => {
    const el = document.querySelector(selector);
    if(!el) return;
    const values = getUniqueValues(key);
    // For multi select (외장색) don't add '전체'
    if(el !== extSelect) {
      el.innerHTML = '<option value=\"\">전체</option>' + values.map(v=>`<option value=\"${escapeHtml(v)}\">${escapeHtml(v)}</option>`).join('');
    } else {
      el.innerHTML = values.map(v=>`<option value=\"${escapeHtml(v)}\">${escapeHtml(v)}</option>`).join('');
    }
  });
}

function escapeHtml(str){
  return (''+str).replace(/[&<>'\"]/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'+'\'':'&#39;'}[s]));
}

function applyFilter(evt){
  if(evt) evt.preventDefault();
  const formData = new FormData(form);
  const criteria = {
    '차종': formData.get('차종') || '',
    '트림': formData.get('트림') || '',
    '옵션': formData.get('옵션') || '',
    '내장색': formData.get('내장색') || '',
    '출고센터': formData.get('출고센터') || '',
    maxPrice: $('#maxPrice').value ? Number($('#maxPrice').value) : null,
    '외장색': [...extSelect.selectedOptions].map(o=>o.value)
  };

  filtered = rawData.filter(r => {
    if(criteria['차종'] && r['차종'] !== criteria['차종']) return false;
    if(criteria['트림'] && r['트림'] !== criteria['트림']) return false;
    if(criteria['옵션'] && r['옵션'] !== criteria['옵션']) return false;
    if(criteria['내장색'] && r['내장색'] !== criteria['내장색']) return false;
    if(criteria['출고센터'] && r['출고센터'] !== criteria['출고센터']) return false;
    if(criteria['외장색'].length > 0 && !criteria['외장색'].includes(r['외장색'])) return false;
    if(criteria.maxPrice !== null && typeof r['판매가'] === 'number' && r['판매가'] > criteria.maxPrice) return false;
    return true;
  });

  renderCount();
  renderTable();
  renderSummary(criteria);
  buildPills(criteria['외장색']);
}

function renderSummary(criteria){
  const parts = [];
  if(criteria['차종']) parts.push('차종=' + criteria['차종']);
  if(criteria['트림']) parts.push('트림=' + criteria['트림']);
  if(criteria['옵션']) parts.push('옵션=' + criteria['옵션']);
  if(criteria['외장색'].length) parts.push('외장색=' + criteria['외장색'].join(','));
  if(criteria['내장색']) parts.push('내장색=' + criteria['내장색']);
  if(criteria['출고센터']) parts.push('출고센터=' + criteria['출고센터']);
  if(criteria.maxPrice !== null) parts.push('≤ ' + criteria.maxPrice.toLocaleString() + '원');
  summaryEl.textContent = parts.length ? '필터: ' + parts.join(' | ') : '';
}

function renderCount(){
  countEl.textContent = `검색 결과는 총 ${filtered.length}대입니다.`;
}

function renderTable(){
  if(filtered.length === 0){
    table.style.display = 'none';
    noResults.style.display = 'block';
    return;
  }
  noResults.style.display = 'none';
  table.style.display = '';
  tbody.innerHTML = filtered.map((r,i)=>{
    const codes = Object.keys(r)
      .filter(k=>k.startsWith('판매코드'))
      .map(k=>r[k])
      .filter(v=>v && v !== '')
      .join('/');
    return `<tr>
      <td>${i+1}</td>
      <td>${escapeHtml(r['차종']||'')}</td>
      <td>${escapeHtml(r['차량상태']||'')}</td>
      <td>${escapeHtml(r['트림']||'')}</td>
      <td>${escapeHtml(r['옵션']||'')}</td>
      <td>${escapeHtml(r['외장색']||'')}</td>
      <td>${escapeHtml(r['내장색']||'')}</td>
      <td>${escapeHtml(r['생산번호']||'')}</td>
      <td>${escapeHtml(r['출고센터']||'')}</td>
      <td>${escapeHtml(r['생산일']||'')}</td>
      <td>${escapeHtml(codes)}</td>
      <td>${ formatPrice(r['판매가']) }</td>
      <td>${escapeHtml(r['조건_계']||r['조건 계']||'')}</td>
    </tr>`;
  }).join('');
}

function formatPrice(v){
  if(typeof v === 'number') return v.toLocaleString() + '원';
  if(typeof v === 'string'){
    const num = v.replace(/[^0-9.-]/g,'');
    if(num) return Number(num).toLocaleString() + '원';
    return v;
  }
  return '';
}

function buildPills(values){
  extPills.innerHTML = values.map(val=>`<span class=\"pill\">${escapeHtml(val)}<button type=\"button\" data-val=\"${escapeHtml(val)}\" aria-label=\"삭제\">×</button></span>`).join('');
}

extPills.addEventListener('click', e=>{
  if(e.target.tagName === 'BUTTON'){
    const val = e.target.getAttribute('data-val');
    [...extSelect.options].forEach(o=>{
      if(o.value === val) o.selected = false;
    });
    applyFilter();
  }
});

form.addEventListener('submit', applyFilter);
$('#resetBtn').addEventListener('click', ()=>{
  form.reset();
  // Clear multi-select
  [...extSelect.options].forEach(o=>o.selected=false);
  $('#maxPrice').value = '';
  applyFilter();
});

extSelect.addEventListener('change', ()=> buildPills([...extSelect.selectedOptions].map(o=>o.value)));

loadData();
</script>
</body>
</html>
